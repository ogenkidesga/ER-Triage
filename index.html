<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊÄ•Ë®∫Ê™¢ÂÇ∑ÂàÜË®∫Ë®àÊï∏Âô® (v3.8 ÂØÜÁ¢º‰øùË≠∑Áâà)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (UMD globals) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* Custom scrollbar for better look */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        /* Animation for countdown */
        @keyframes pulse-red {
            0%, 100% { color: #dc2626; }
            50% { color: #991b1b; }
        }
        .countdown-text {
            animation: pulse-red 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Animation for Time Up Alert */
        @keyframes flash-warning {
            0%, 100% { background-color: #fee2e2; border-color: #ef4444; } /* Red-100 */
            50% { background-color: #fca5a5; border-color: #b91c1c; } /* Red-300 */
        }
        .animate-flash-warning {
            animation: flash-warning 1s infinite;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useMemo, useRef } = React;
        const { createRoot } = ReactDOM;

        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { 
            getFirestore, collection, doc, setDoc, onSnapshot, 
            updateDoc, deleteDoc, serverTimestamp, query, orderBy, runTransaction, writeBatch, where, getDocs
        } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
        import { 
            getAuth, signInAnonymously, onAuthStateChanged 
        } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';

        // --- Icons ---
        const Activity = ({ className, size }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
        );
        const PauseCircle = ({ className, size }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><line x1="10" y1="15" x2="10" y2="9"></line><line x1="14" y1="15" x2="14" y2="9"></line></svg>
        );
        const RotateCw = ({ className, size }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path></svg>
        );
        const Trash2 = ({ className, size }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
        );
        const Plus = ({ className, size }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        );
        const CheckCircle = ({ className, size }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
        );
        const Settings = ({ className, size }) => (
             <svg xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
        );
        const Stethoscope = ({ className, size }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M4.8 2.3A.3.3 0 1 0 5.2.7l-1.5 2.5 1.1-.9z"></path><path d="M6 5a6 6 0 0 1 12 0v3"></path><path d="M11 17h2"></path><path d="M8 17a4 4 0 0 1 8 0v-4a2 2 0 1 0-4 0v2"></path><circle cx="12" cy="19" r="2"></circle></svg>
        );
        const XCircle = ({ className, size }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>
        );
        const RefreshCw = ({ className, size }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
        );
        const AlertTriangle = ({ className, size }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
        );
        const Lock = ({ className, size }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
        );
        const Unlock = ({ className, size }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 9.9-1"></path></svg>
        );

        // --- Firebase Config & Init (Ê≠£ÂºèÁí∞Â¢É) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAA9_VgFhFKJZidgfbYkAI4g46SowgVBYY",
            authDomain: "er-triage-b1ac6.firebaseapp.com",
            projectId: "er-triage-b1ac6",
            storageBucket: "er-triage-b1ac6.firebasestorage.app",
            messagingSenderId: "691660481020",
            appId: "1:691660481020:web:8c06b22c69320cbce81279"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const PATIENTS_COLLECTION = 'er_triage_patients';
        const STATE_COLLECTION = 'er_triage_state';
        const STATE_DOC_ID = 'main_v2';

        // --- Constants ---
        const ROOM_DEFINITIONS = [
            { id: 1, name: 'Ë®∫‰∏Ä', color: 'bg-yellow-200', header: 'bg-yellow-400', border: 'border-yellow-400', text: 'text-yellow-900' },
            { id: 2, name: 'Ë®∫‰∫å', color: 'bg-green-200', header: 'bg-green-500', border: 'border-green-500', text: 'text-green-900' },
            { id: 3, name: 'Ë®∫‰∏â', color: 'bg-blue-200', header: 'bg-blue-400', border: 'border-blue-400', text: 'text-blue-900' },
            { id: 4, name: 'Ë®∫Âõõ', color: 'bg-orange-200', header: 'bg-orange-400', border: 'border-orange-400', text: 'text-orange-900' },
            { id: 5, name: 'Ë®∫‰∫î', color: 'bg-pink-200', header: 'bg-pink-400', border: 'border-pink-400', text: 'text-pink-900' },
            { id: 6, name: 'Ë®∫ÂÖ≠', color: 'bg-purple-200', header: 'bg-purple-400', border: 'border-purple-400', text: 'text-purple-900' },
            { id: 7, name: 'Ë®∫‰∏É', color: 'bg-teal-200', header: 'bg-teal-400', border: 'border-teal-400', text: 'text-teal-900' },
        ];

        const INITIAL_STATE = {
            activeRoomIds: [1, 2, 3, 4], // È†êË®≠ÈñãÂïüË®∫ 1-4
            activeRoomCount: 4, // ‰øùÁïôËàäÊ¨Ñ‰ΩçÂÖºÂÆπ
            rotation: {
                level1_next: 1,
                others_next: 1,
                level1_last: 0, 
                others_last: 0 
            },
            suspensions: {}
        };

        const SUSPENSION_DURATION_MS = 30 * 60 * 1000;
        const ADMIN_PASSWORD = "5323911@";

        // --- Modal Components ---
        const Modal = ({ isOpen, onClose, title, children, showClose = true }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-60 backdrop-blur-sm animate-[fadeIn_0.2s_ease-out]">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all scale-100">
                        <div className="flex justify-between items-center p-4 border-b bg-gray-50">
                            <h3 className="text-xl font-bold text-gray-800 flex items-center gap-2">{title}</h3>
                            {showClose && (
                                <button onClick={onClose} className="text-gray-500 hover:text-gray-700 p-1 rounded-full hover:bg-gray-200">
                                    <XCircle size={24} />
                                </button>
                            )}
                        </div>
                        <div className="p-6">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        function App() {
            const [user, setUser] = useState(null);
            const [patients, setPatients] = useState([]);
            const [systemState, setSystemState] = useState(INITIAL_STATE);
            
            // Local UI State
            const [inputMrn, setInputMrn] = useState('');
            const [inputLevel, setInputLevel] = useState(3);
            const [isMajorTrauma, setIsMajorTrauma] = useState(false);
            const [isOhca, setIsOhca] = useState(false);
            const [loading, setLoading] = useState(false);
            const [, setTick] = useState(0);
            
            const [targetRoom, setTargetRoom] = useState(1);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [adminLoading, setAdminLoading] = useState(false);

            // New State for Critical Patient Confirmation
            const [criticalConfirmData, setCriticalConfirmData] = useState(null);

            // Authentication State
            const [isAdmin, setIsAdmin] = useState(false);
            const [showAuthModal, setShowAuthModal] = useState(false);
            const [passwordInput, setPasswordInput] = useState('');

            // --- Auth & Data Fetching ---
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        await signInAnonymously(auth);
                    } catch (e) {
                        console.error("Auth error", e);
                    }
                };
                initAuth();
                
                // Check local storage for persistent admin login
                const storedAuth = localStorage.getItem('er_triage_auth');
                if (storedAuth === ADMIN_PASSWORD) {
                    setIsAdmin(true);
                }

                const unsubscribe = onAuthStateChanged(auth, setUser);
                const timer = setInterval(() => setTick(t => t + 1), 1000);
                return () => {
                    unsubscribe();
                    clearInterval(timer);
                };
            }, []);

            useEffect(() => {
                if (!user) return;

                const qPatients = query(collection(db, PATIENTS_COLLECTION), orderBy('timestamp', 'desc'));
                const unsubPatients = onSnapshot(qPatients, (snapshot) => {
                    const list = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setPatients(list);
                }, (error) => console.error("Patients fetch error:", error));

                const docRef = doc(db, STATE_COLLECTION, STATE_DOC_ID);
                const unsubState = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        setSystemState(docSnap.data());
                    } else {
                        setDoc(docRef, INITIAL_STATE);
                    }
                }, (error) => console.error("State fetch error:", error));

                return () => {
                    unsubPatients();
                    unsubState();
                };
            }, [user]);

            // --- Logic Helpers ---
            const activeRoomIds = useMemo(() => {
                if (systemState.activeRoomIds && Array.isArray(systemState.activeRoomIds)) {
                    return systemState.activeRoomIds.sort((a,b) => a-b);
                }
                const count = systemState.activeRoomCount || 4;
                return Array.from({length: count}, (_, i) => i + 1);
            }, [systemState]);

            const activeRooms = useMemo(() => {
                return ROOM_DEFINITIONS.filter(r => activeRoomIds.includes(r.id));
            }, [activeRoomIds]);

            const getNextIdFromLast = (lastRoomId, idsList) => {
                if (!idsList || idsList.length === 0) return 1;
                const sorted = [...idsList].sort((a,b)=>a-b);
                const nextGreater = sorted.find(id => id > lastRoomId);
                return nextGreater || sorted[0];
            };

            const getRoomSuspensionState = (roomId) => {
                const suspendedUntil = systemState.suspensions?.[roomId];
                if (!suspendedUntil) return 'NONE'; 
                if (suspendedUntil > Date.now()) return 'ACTIVE'; 
                return 'EXPIRED'; 
            };

            const isRoomActiveSuspension = (roomId) => {
                return getRoomSuspensionState(roomId) === 'ACTIVE';
            };
            
            const isRoomSkippable = (roomId) => {
                return isRoomActiveSuspension(roomId);
            };

            const getRotationType = (level) => {
                return parseInt(level) === 1 ? 'level1' : 'others';
            };

            const calculateNextRoom = (level) => {
                const type = getRotationType(level);
                const lastKey = type + '_last';
                const nextKey = type + '_next';
                const lastRoomId = systemState.rotation?.[lastKey];
                
                let pointer;
                if (lastRoomId !== undefined && lastRoomId !== 0) {
                    pointer = getNextIdFromLast(lastRoomId, activeRoomIds);
                } else {
                    pointer = systemState.rotation?.[nextKey] || 1;
                    if (!activeRoomIds.includes(pointer)) {
                        pointer = activeRoomIds[0] || 1;
                    }
                }

                let attempts = 0;
                while (isRoomSkippable(pointer) && attempts < activeRoomIds.length) {
                    pointer = getNextIdFromLast(pointer, activeRoomIds);
                    attempts++;
                }
                return pointer;
            };

            const suggestedRoomId = useMemo(() => {
                return calculateNextRoom(inputLevel);
            }, [inputLevel, systemState, activeRoomIds]);

            useEffect(() => {
                setTargetRoom(suggestedRoomId);
            }, [suggestedRoomId]);

            const stats = useMemo(() => {
                const initialStats = {};
                ROOM_DEFINITIONS.forEach(r => {
                    initialStats[r.id] = { level1: 0, others: 0, mt: 0, ohca: 0 };
                });
                patients.forEach(p => {
                    if (initialStats[p.roomId]) {
                        if (p.level === 1) initialStats[p.roomId].level1++;
                        else initialStats[p.roomId].others++;
                        if (p.isMajorTrauma) initialStats[p.roomId].mt++;
                        if (p.isOhca) initialStats[p.roomId].ohca++;
                    }
                });
                return initialStats;
            }, [patients]);

            // --- Auth Actions ---
            const handleLogin = () => {
                if (passwordInput === ADMIN_PASSWORD) {
                    setIsAdmin(true);
                    localStorage.setItem('er_triage_auth', ADMIN_PASSWORD);
                    setShowAuthModal(false);
                    setPasswordInput('');
                } else {
                    alert("ÂØÜÁ¢ºÈåØË™§ÔºÅ");
                    setPasswordInput('');
                }
            };

            const handleLogout = () => {
                if (window.confirm("Á¢∫ÂÆöË¶ÅÁôªÂá∫‰∏¶ÈéñÂÆöÂÑÄË°®ÊùøÂóéÔºü")) {
                    setIsAdmin(false);
                    localStorage.removeItem('er_triage_auth');
                    setIsSettingsOpen(false);
                }
            };

            const handleSettingsClick = () => {
                if (!isAdmin) {
                    setShowAuthModal(true);
                } else {
                    setIsSettingsOpen(true);
                }
            };

            // --- Actions ---
            const toggleActiveRoom = async (roomId) => {
                if (!isAdmin) return; // Protected
                const stateRef = doc(db, STATE_COLLECTION, STATE_DOC_ID);
                let newIds = [...activeRoomIds];
                if (newIds.includes(roomId)) {
                    if (newIds.length <= 1) return;
                    newIds = newIds.filter(id => id !== roomId);
                } else {
                    newIds.push(roomId);
                }
                newIds.sort((a,b) => a-b);
                await updateDoc(stateRef, { activeRoomIds: newIds, activeRoomCount: newIds.length });
            };

            const handleAddPatientClick = () => {
                if (!isAdmin) return; // Protected
                if (!inputMrn.trim()) return;
                if (isOhca || isMajorTrauma) {
                    setCriticalConfirmData({
                        targetRoomName: ROOM_DEFINITIONS.find(r => r.id === parseInt(targetRoom))?.name || `Ë®∫${targetRoom}`
                    });
                    return; 
                }
                performAddPatient(false);
            };

            const performAddPatient = async (shouldSuspendRoom) => {
                if (!user || !isAdmin) return; // Protected
                setLoading(true);
                setCriticalConfirmData(null); 

                try {
                    const assignedRoomId = parseInt(targetRoom);
                    const type = getRotationType(inputLevel);
                    const nextKey = type + '_next';
                    const lastKey = type + '_last';
                    
                    const newPatient = {
                        mrn: inputMrn.trim(),
                        level: parseInt(inputLevel),
                        isMajorTrauma,
                        isOhca,
                        roomId: assignedRoomId,
                        timestamp: Date.now() 
                    };

                    await runTransaction(db, async (transaction) => {
                        const stateRef = doc(db, STATE_COLLECTION, STATE_DOC_ID);
                        const stateDoc = await transaction.get(stateRef);
                        let currentState = stateDoc.exists() ? stateDoc.data() : INITIAL_STATE;
                        let currentRotation = currentState.rotation || INITIAL_STATE.rotation;
                        let currentActiveIds = [];
                        if (currentState.activeRoomIds && Array.isArray(currentState.activeRoomIds)) {
                            currentActiveIds = currentState.activeRoomIds.sort((a,b)=>a-b);
                        } else {
                            const c = currentState.activeRoomCount || 4;
                            currentActiveIds = Array.from({length: c}, (_, i) => i + 1);
                        }
                        const currIdx = currentActiveIds.indexOf(assignedRoomId);
                        let nextPointerLegacy;
                        if (currIdx === -1) {
                            nextPointerLegacy = currentActiveIds[0];
                        } else {
                            nextPointerLegacy = currentActiveIds[(currIdx + 1) % currentActiveIds.length];
                        }
                        const newRotation = {
                            ...currentRotation,
                            [nextKey]: nextPointerLegacy,
                            [lastKey]: assignedRoomId
                        };
                        const newPatientRef = doc(collection(db, PATIENTS_COLLECTION));
                        transaction.set(newPatientRef, newPatient);
                        let updatePayload = { rotation: newRotation };
                        if (shouldSuspendRoom) {
                            const newSuspensionTime = Date.now() + SUSPENSION_DURATION_MS;
                            updatePayload[`suspensions.${assignedRoomId}`] = newSuspensionTime;
                        }
                        transaction.set(stateRef, updatePayload, { merge: true });
                    });
                    setInputMrn('');
                    setIsMajorTrauma(false);
                    setIsOhca(false);
                } catch (e) {
                    console.error("Add patient failed", e);
                    alert(`ÊéõËôüÂ§±Êïó: ${e.message}`);
                } finally {
                    setLoading(false);
                }
            };

            const toggleSuspension = async (roomId) => {
                if (!isAdmin) return; // Protected
                const state = getRoomSuspensionState(roomId);
                const shouldSuspend = state === 'NONE';
                const newState = shouldSuspend ? Date.now() + SUSPENSION_DURATION_MS : null;
                const stateRef = doc(db, STATE_COLLECTION, STATE_DOC_ID);
                await updateDoc(stateRef, { [`suspensions.${roomId}`]: newState || 0 });
            };

            const handleResetRotation = async (mode) => {
                if (!isAdmin) return; // Protected
                if (!window.confirm("Á¢∫ÂÆöÈáçÁΩÆËº™Â∫è?")) return;
                setAdminLoading(true);
                try {
                    const updateData = {};
                    if (mode === 'all' || mode === 'level1') {
                        updateData['rotation.level1_next'] = 1;
                        updateData['rotation.level1_last'] = 0; 
                    }
                    if (mode === 'all' || mode === 'others') {
                        updateData['rotation.others_next'] = 1;
                        updateData['rotation.others_last'] = 0;
                    }
                    await updateDoc(doc(db, STATE_COLLECTION, STATE_DOC_ID), updateData);
                } catch (e) { alert(e.message); }
                finally { setAdminLoading(false); }
            };

            const handleClearPatients = async (roomId) => {
                if (!isAdmin) return; // Protected
                if (!window.confirm("Á¢∫ÂÆöÊ∏ÖÁ©∫ÁóÖ‰∫∫Ë≥áÊñô?")) return;
                setAdminLoading(true);
                try {
                    const q = roomId ? query(collection(db, PATIENTS_COLLECTION), where("roomId", "==", roomId)) : query(collection(db, PATIENTS_COLLECTION));
                    const snapshot = await getDocs(q);
                    const batch = writeBatch(db);
                    snapshot.docs.forEach(d => batch.delete(d.ref));
                    await batch.commit();
                } catch (e) { alert(e.message); }
                finally { setAdminLoading(false); }
            };

            const handleDeletePatient = async (id) => {
                if (!isAdmin) return; // Protected
                if (window.confirm && !window.confirm('Á¢∫ÂÆöË¶ÅÁßªÈô§Ê≠§ÁóÖÊ≠∑ËôüÂóéÔºü')) return; 
                try { await deleteDoc(doc(db, PATIENTS_COLLECTION, id)); } catch (e) {}
            };

            // --- Render Helpers ---
            const getFormatRemainingTime = (timestamp) => {
                if (!timestamp) return '';
                const diff = timestamp - Date.now();
                if (diff <= 0) return '00ÂàÜ00Áßí'; 
                const m = Math.floor(diff / 60000);
                const s = Math.floor((diff % 60000) / 1000);
                const ss = s < 10 ? `0${s}` : s;
                return `${m}ÂàÜ${ss}Áßí`;
            };

            const gridStyle = {
                display: 'grid',
                gridTemplateColumns: `100px repeat(${activeRooms.length}, minmax(0, 1fr))`,
                gap: '0.5rem'
            };

            return (
                <div className="min-h-screen bg-gray-50 text-gray-800 font-sans p-2 md:p-4">
                    
                    {/* AUTH MODAL */}
                    <Modal 
                        isOpen={showAuthModal} 
                        onClose={() => setShowAuthModal(false)}
                        title="üîí ÁÆ°ÁêÜÂì°ÁôªÂÖ•"
                    >
                        <div className="space-y-4">
                            <p className="text-gray-600">Ë´ãËº∏ÂÖ•ÁÆ°ÁêÜÂØÜÁ¢º‰ª•Ëß£ÈéñÂÑÄË°®ÊùøÊéßÂà∂Ê¨äÔºö</p>
                            <input 
                                type="password" 
                                value={passwordInput}
                                onChange={(e) => setPasswordInput(e.target.value)}
                                className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 text-xl font-mono text-center"
                                placeholder="‚óè‚óè‚óè‚óè‚óè‚óè‚óè‚óè"
                                autoFocus
                                onKeyDown={(e) => e.key === 'Enter' && handleLogin()}
                            />
                            <button 
                                onClick={handleLogin}
                                className="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-bold shadow"
                            >
                                ÁôªÂÖ•Ëß£Èéñ
                            </button>
                        </div>
                    </Modal>

                    {/* CRITICAL PATIENT MODAL */}
                    <Modal 
                        isOpen={!!criticalConfirmData} 
                        onClose={() => setCriticalConfirmData(null)}
                        title={<><AlertTriangle className="text-red-600" /> ÈáçÁóáÁóÖ‰∫∫Á¢∫Ë™ç</>}
                        showClose={false}
                    >
                         <div className="text-center space-y-4">
                            <p className="text-lg font-bold text-gray-800">
                                ÊÇ®Ê≠£Âú®Â∞á <span className="text-red-600">OHCA/Trauma</span> ÁóÖ‰∫∫<br/>ÊéõÂÖ• 
                                <span className="text-indigo-600 text-2xl mx-2">{criticalConfirmData?.targetRoomName}</span>
                            </p>
                            <p className="text-gray-600">ÊòØÂê¶Ë¶ÅÂêåÊ≠•Â∞áË©≤Ë®∫ÈñìË®≠ÁÇ∫<br/><span className="font-bold text-gray-800">ÂÅúË®∫ 30 ÂàÜÈêò</span> ‰ª•ÈÄ≤Ë°åÊÄ•ÊïëÔºü</p>
                            
                            <div className="flex flex-col gap-3 mt-4">
                                <button 
                                    onClick={() => performAddPatient(true)}
                                    className="w-full bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg font-bold shadow text-lg flex items-center justify-center gap-2"
                                >
                                    <PauseCircle size={20} /> ÊòØÔºåÊéõËôü‰∏¶ÂÅúË®∫
                                </button>
                                <button 
                                    onClick={() => performAddPatient(false)}
                                    className="w-full bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-lg font-bold shadow text-lg"
                                >
                                    Âê¶ÔºåÂÉÖÊéõËôü
                                </button>
                                <button 
                                    onClick={() => setCriticalConfirmData(null)}
                                    className="w-full bg-white border-2 border-gray-300 text-gray-600 py-2 rounded-lg font-bold hover:bg-gray-50"
                                >
                                    ÂèñÊ∂à
                                </button>
                            </div>
                        </div>
                    </Modal>

                    {/* ADMIN SETTINGS MODAL */}
                    <Modal 
                        isOpen={isSettingsOpen} 
                        onClose={() => setIsSettingsOpen(false)}
                        title="‚öôÔ∏è ‰∫§Áè≠ËàáÁ≥ªÁµ±ÁÆ°ÁêÜ"
                    >
                        <div className="space-y-6">
                            <div>
                                <h4 className="font-bold text-gray-700 mb-2 flex items-center gap-2">
                                    <RefreshCw size={18} /> Ëº™Â∫èÈáçÁΩÆ
                                </h4>
                                <div className="grid grid-cols-2 gap-2 mb-2">
                                    <button disabled={adminLoading} onClick={() => handleResetRotation('level1')} className="bg-blue-100 text-blue-800 py-2 rounded font-bold">L1 ÈáçÁΩÆ</button>
                                    <button disabled={adminLoading} onClick={() => handleResetRotation('others')} className="bg-green-100 text-green-800 py-2 rounded font-bold">ÂÖ∂‰ªñÈáçÁΩÆ</button>
                                </div>
                                <button disabled={adminLoading} onClick={() => handleResetRotation('all')} className="w-full bg-indigo-100 text-indigo-800 py-2 rounded font-bold border-2 border-indigo-200">ÂÖ®ÈÉ®ÈáçÁΩÆ</button>
                            </div>
                            <hr className="border-gray-200" />
                            <div>
                                <h4 className="font-bold text-red-700 mb-2 flex items-center gap-2"><Trash2 size={18} /> Âç±Èö™Êìç‰ΩúÂçÄ</h4>
                                <button disabled={adminLoading} onClick={() => handleClearPatients(null)} className="w-full bg-red-600 text-white py-3 rounded-lg font-bold shadow">Ê∏ÖÈô§ÊâÄÊúâË≥áÊñô</button>
                            </div>
                            <hr className="border-gray-200" />
                            <button 
                                onClick={handleLogout}
                                className="w-full bg-gray-500 hover:bg-gray-600 text-white py-2 rounded font-bold flex items-center justify-center gap-2"
                            >
                                <Lock size={16} /> ÁôªÂá∫‰∏¶ÈéñÂÆö (Logout)
                            </button>
                        </div>
                    </Modal>

                    {/* HEADER */}
                    <header className="mb-6 bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                        <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                            <div className="flex items-center gap-3">
                                <Activity className="text-red-600 w-8 h-8" />
                                <h1 className="text-2xl font-bold tracking-tight text-gray-800">ÊÄ•Ë®∫Ê™¢ÂÇ∑ÂàÜÊµÅË®àÊï∏Âô® (v3.8)</h1>
                                {isAdmin ? (
                                    <span className="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full font-bold flex items-center gap-1 border border-green-200">
                                        <Unlock size={12} /> ÁÆ°ÁêÜÂì°
                                    </span>
                                ) : (
                                    <span className="bg-gray-100 text-gray-500 text-xs px-2 py-1 rounded-full font-bold flex items-center gap-1 border border-gray-300">
                                        <Lock size={12} /> Ë®™ÂÆ¢Ê®°Âºè (ÂÉÖ‰æõËßÄÁúã)
                                    </span>
                                )}
                            </div>
                            <div className={`flex items-center gap-2 bg-gray-100 p-1.5 rounded-lg border border-gray-200 overflow-x-auto max-w-full ${!isAdmin ? 'opacity-50 pointer-events-none' : ''}`}>
                                <div className="text-xs font-bold text-gray-500 px-2 whitespace-nowrap flex items-center gap-1"><Settings size={14}/> ÈñãË®∫Ë®≠ÂÆö:</div>
                                {[1, 2, 3, 4, 5, 6, 7].map(num => (
                                    <button 
                                        key={num} 
                                        onClick={() => toggleActiveRoom(num)} 
                                        className={`w-8 h-8 rounded-md font-bold text-sm transition-all border
                                            ${activeRoomIds.includes(num)
                                                ? 'bg-indigo-600 text-white border-indigo-600 shadow-md transform scale-105' 
                                                : 'bg-white text-gray-400 border-gray-200 hover:bg-gray-50'}`}
                                    >
                                        {num}
                                    </button>
                                ))}
                            </div>
                            <div className="flex items-center gap-3">
                                <button 
                                    onClick={handleSettingsClick} 
                                    className={`flex items-center gap-1 px-3 py-2 rounded-lg font-bold border text-sm transition-colors
                                        ${isAdmin 
                                            ? 'bg-gray-100 text-gray-700 border-gray-300 hover:bg-gray-200' 
                                            : 'bg-indigo-50 text-indigo-700 border-indigo-200 hover:bg-indigo-100'}`}
                                >
                                    {isAdmin ? <Settings size={16} /> : <Lock size={16} />} 
                                    {isAdmin ? '‰∫§Áè≠/ÁÆ°ÁêÜ' : 'ÁôªÂÖ•'}
                                </button>
                                <div className="text-sm text-gray-500 flex items-center gap-2 whitespace-nowrap"><span className={`w-2.5 h-2.5 rounded-full ${user ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`}></span>{user ? 'ÈÄ£Á∑ö‰∏≠' : '...'}</div>
                            </div>
                        </div>
                    </header>

                    {/* DASHBOARD */}
                    <div className="mb-6 overflow-x-auto pb-2">
                        <div style={gridStyle} className="min-w-[600px]">
                            {/* Headers */}
                            <div className="flex flex-col gap-2 pt-14 text-right pr-4 font-bold text-gray-600 text-sm md:text-base">
                                <div className="h-10 flex items-center justify-end">ÁãÄÊÖã</div>
                                <div className="h-8 flex items-center justify-end">‰∏ÄÁ¥öÁóÖ‰∫∫</div>
                                <div className="h-8 flex items-center justify-end">ÂÖ∂‰ªñÁóÖ‰∫∫</div>
                                <div className="h-8 flex items-center justify-end text-red-600">Major Trauma</div>
                                <div className="h-8 flex items-center justify-end text-red-600">OHCA</div>
                                <div className="h-8 flex items-center justify-end text-blue-600">‰∏ÄÁ¥öËº™Â∫è</div>
                                <div className="h-8 flex items-center justify-end text-green-600">ÂÖ∂‰ªñËº™Â∫è</div>
                            </div>

                            {/* Rooms */}
                            {activeRooms.map(room => {
                                const suspensionState = getRoomSuspensionState(room.id); // NONE, ACTIVE, EXPIRED
                                const isSuspended = suspensionState !== 'NONE';
                                const nextForLevel1 = calculateNextRoom(1) === room.id;
                                const nextForOthers = calculateNextRoom(3) === room.id;

                                return (
                                    <div key={room.id} className={`flex flex-col gap-2 rounded-lg ${room.color} bg-opacity-20 p-2 border ${room.border}`}>
                                        <div className={`${room.header} text-white font-bold text-center py-2 rounded shadow-sm text-lg relative whitespace-nowrap overflow-hidden text-ellipsis`}>
                                            {room.name}
                                            {suspensionState === 'ACTIVE' && (
                                                <div className="absolute top-0 right-0 left-0 bottom-0 bg-red-600 bg-opacity-90 text-white flex items-center justify-center text-xs font-bold animate-pulse">
                                                    ÂÅúË®∫‰∏≠
                                                </div>
                                            )}
                                            {suspensionState === 'EXPIRED' && (
                                                <div className="absolute top-0 right-0 left-0 bottom-0 bg-red-800 text-white flex items-center justify-center text-xs font-bold animate-bounce">
                                                    ‚ö†Ô∏è ÊôÇÈñìÂà∞
                                                </div>
                                            )}
                                        </div>

                                        <div className="h-10 flex items-center justify-center">
                                            <button
                                                onClick={() => toggleSuspension(room.id)}
                                                disabled={!isAdmin}
                                                className={`text-[10px] md:text-xs w-full py-1 rounded border shadow-sm transition-all flex items-center justify-center gap-1 font-bold h-full disabled:opacity-50 disabled:cursor-not-allowed
                                                    ${suspensionState === 'ACTIVE' 
                                                        ? 'bg-red-50 border-red-300 text-red-700' 
                                                        : suspensionState === 'EXPIRED'
                                                            ? 'bg-red-100 border-red-500 text-red-800 animate-flash-warning'
                                                            : 'bg-white border-gray-300 text-gray-600 hover:bg-gray-100'
                                                    }`}
                                            >
                                                {suspensionState === 'ACTIVE' ? (
                                                    <span className="flex flex-col items-center leading-none">
                                                        <span>ÊÅ¢Âæ©</span>
                                                        <span className="scale-90 font-mono text-red-600 countdown-text text-xs mt-0.5">
                                                            {getFormatRemainingTime(systemState.suspensions[room.id])}
                                                        </span>
                                                    </span>
                                                ) : suspensionState === 'EXPIRED' ? (
                                                    <span className="flex flex-col items-center leading-none">
                                                        <span className="text-sm">ÊôÇÈñìÂà∞</span>
                                                        <span className="text-[10px]">ÈªûÊìäÊÅ¢Âæ©</span>
                                                    </span>
                                                ) : (
                                                    <>
                                                        <PauseCircle size={14} /> ÂÅúË®∫ 30m
                                                    </>
                                                )}
                                            </button>
                                        </div>

                                        <div className="h-8 flex items-center justify-center font-mono font-bold text-xl bg-white bg-opacity-50 rounded">{stats[room.id]?.level1 || 0}</div>
                                        <div className="h-8 flex items-center justify-center font-mono font-bold text-xl bg-white bg-opacity-50 rounded">{stats[room.id]?.others || 0}</div>
                                        <div className="h-8 flex items-center justify-center font-mono font-bold text-xl bg-white bg-opacity-50 rounded text-red-700">{stats[room.id]?.mt || 0}</div>
                                        <div className="h-8 flex items-center justify-center font-mono font-bold text-xl bg-white bg-opacity-50 rounded text-red-700">{stats[room.id]?.ohca || 0}</div>
                                        
                                        <div className="h-8 flex items-center justify-center">
                                            {nextForLevel1 ? <div className="w-full h-full bg-blue-500 text-white rounded flex items-center justify-center text-xs font-bold animate-pulse shadow">NEXT</div> : <span className="text-gray-300">-</span>}
                                        </div>
                                        <div className="h-8 flex items-center justify-center">
                                            {nextForOthers ? <div className="w-full h-full bg-green-500 text-white rounded flex items-center justify-center text-xs font-bold animate-pulse shadow">NEXT</div> : <span className="text-gray-300">-</span>}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {/* INPUT AREA */}
                    <div className={`bg-white rounded-xl shadow-md p-4 md:p-6 border-l-4 border-indigo-500 mb-6 transition-opacity ${!isAdmin ? 'opacity-60 pointer-events-none grayscale' : ''}`}>
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-lg font-bold flex items-center gap-2 text-indigo-700">
                                <Plus className="w-5 h-5" />
                                Êñ∞ÁóÖ‰∫∫ÊéõËôüËº∏ÂÖ•
                            </h2>
                            {!isAdmin && <span className="text-xs bg-gray-200 text-gray-500 px-2 py-1 rounded font-bold">üîí ÂÉÖ‰æõËßÄÁúã</span>}
                        </div>
                        
                        <div className="flex flex-col lg:flex-row gap-6 items-start lg:items-end">
                            <div className="flex-1 w-full">
                                <label className="block text-sm font-bold text-gray-700 mb-1">‰ª£Á¢º</label>
                                <input 
                                    type="text" 
                                    value={inputMrn}
                                    onChange={(e) => setInputMrn(e.target.value)}
                                    placeholder={isAdmin ? "Ëº∏ÂÖ•‰ª£Á¢º..." : "Â∑≤ÈéñÂÆö"}
                                    disabled={!isAdmin}
                                    className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none text-xl font-mono"
                                    onKeyDown={(e) => e.key === 'Enter' && handleAddPatientClick()}
                                />
                            </div>

                            <div className="w-full lg:w-auto">
                                <label className="block text-sm font-bold text-gray-700 mb-1">Ê™¢ÂÇ∑Á¥öÊï∏</label>
                                <div className="flex gap-2">
                                    {[1, 2, 3, 4, 5].map(level => (
                                        <button
                                            key={level}
                                            onClick={() => setInputLevel(level)}
                                            disabled={!isAdmin}
                                            className={`w-12 h-12 rounded-lg font-bold text-xl border-2 transition-all shadow-sm
                                                ${parseInt(inputLevel) === level
                                                    ? (level === 1 ? 'bg-red-600 text-white border-red-600 shadow-md transform scale-105' : 'bg-indigo-600 text-white border-indigo-600 shadow-md transform scale-105')
                                                    : 'bg-white text-gray-500 border-gray-200 hover:bg-gray-50'
                                                }`}
                                        >
                                            {level}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            <div className="flex flex-wrap gap-2 md:gap-4 mb-2 lg:mb-3 w-full lg:w-auto">
                                <label className={`flex-1 lg:flex-none flex items-center justify-center gap-2 px-3 py-2 rounded cursor-pointer transition-all border-2
                                    ${isMajorTrauma ? 'bg-red-100 border-red-500 text-red-700 font-bold' : 'bg-gray-100 border-gray-200 text-gray-500'}`}>
                                    <input 
                                        type="checkbox" 
                                        checked={isMajorTrauma} 
                                        disabled={!isAdmin}
                                        onChange={(e) => setIsMajorTrauma(e.target.checked)}
                                        className="w-5 h-5 accent-red-600"
                                    />
                                    <span className="whitespace-nowrap text-sm">Trauma</span>
                                </label>

                                <label className={`flex-1 lg:flex-none flex items-center justify-center gap-2 px-3 py-2 rounded cursor-pointer transition-all border-2
                                    ${isOhca ? 'bg-black text-white border-black font-bold' : 'bg-gray-100 border-gray-200 text-gray-500'}`}>
                                    <input 
                                        type="checkbox" 
                                        checked={isOhca} 
                                        disabled={!isAdmin}
                                        onChange={(e) => {
                                            setIsOhca(e.target.checked);
                                            if (e.target.checked) setInputLevel(1); 
                                        }}
                                        className="w-5 h-5 accent-red-600"
                                    />
                                    <span className="whitespace-nowrap text-sm">OHCA</span>
                                </label>
                            </div>

                            <div className="flex flex-col w-full">
                                <label className="block text-sm font-bold text-gray-700 mb-1 flex items-center gap-1">
                                    <Stethoscope size={14} /> ÊåáÂÆöË®∫Èñì
                                </label>
                                <div className="flex flex-wrap gap-2">
                                    {activeRooms.map(room => {
                                        const isSelected = parseInt(targetRoom) === room.id;
                                        const isSuggested = suggestedRoomId === room.id;
                                        
                                        return (
                                            <button
                                                key={room.id}
                                                onClick={() => setTargetRoom(room.id)}
                                                disabled={!isAdmin}
                                                className={`px-3 py-2 rounded-lg font-bold text-sm border-2 transition-all shadow-sm flex flex-col items-center justify-center min-w-[60px]
                                                    ${isSelected
                                                        ? 'bg-indigo-600 text-white border-indigo-600 shadow-md transform scale-105'
                                                        : 'bg-white text-gray-500 border-gray-200 hover:bg-gray-50'
                                                    }
                                                    ${isSuggested && !isSelected ? 'border-indigo-300 bg-indigo-50 text-indigo-900' : ''}
                                                `}
                                            >
                                                <span>{room.name}</span>
                                                {isSuggested && (
                                                    <span className={`text-[10px] ${isSelected ? 'text-indigo-200' : 'text-indigo-500'}`}>
                                                        (Âª∫Ë≠∞)
                                                    </span>
                                                )}
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>
                            
                            <div className="w-full flex justify-end">
                                <button
                                    onClick={handleAddPatientClick}
                                    disabled={!inputMrn || loading || !isAdmin}
                                    className="h-[52px] bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-400 text-white px-6 rounded-lg font-bold shadow-lg transition-transform active:scale-95 text-lg flex items-center justify-center gap-2 whitespace-nowrap"
                                >
                                    {loading ? <RotateCw className="animate-spin" /> : <><CheckCircle /> Á¢∫Ë™ç</>}
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* PATIENT LIST */}
                    <h3 className="text-xl font-bold text-gray-700 mb-4 pl-2 border-l-4 border-gray-400">ÁõÆÂâçÊ∏ÖÂñÆ (List)</h3>
                    <div className="overflow-x-auto pb-4">
                        <div style={gridStyle} className="min-w-[600px]">
                            <div className="pt-2 text-right pr-4 text-gray-500 font-medium text-sm">
                                <div>ÊôÇÈñì / È†ÖÁõÆ</div>
                            </div>
                            {activeRooms.map(room => {
                                const roomPatients = patients.filter(p => p.roomId === room.id);
                                return (
                                    <div key={room.id} className="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden flex flex-col min-h-[300px]">
                                        <div className={`${room.header} text-white font-bold text-center py-1 text-sm flex justify-between px-2 items-center`}>
                                            <span className="flex-1">{room.name}</span>
                                            <button 
                                                onClick={() => handleClearPatients(room.id)} 
                                                disabled={!isAdmin}
                                                className="bg-white bg-opacity-20 hover:bg-opacity-40 rounded p-1 text-white transition-colors disabled:opacity-0" 
                                                title={`Ê∏ÖÁ©∫${room.name}ÁóÖ‰∫∫`}
                                            >
                                                <Trash2 size={12} />
                                            </button>
                                        </div>
                                        <div className="p-2 flex-1 overflow-y-auto max-h-[500px] space-y-2">
                                            {roomPatients.length === 0 && <div className="text-center text-gray-300 py-8 text-sm italic">ÁÑ°ÁóÖ‰∫∫</div>}
                                            {roomPatients.map(p => (
                                                <div key={p.id} className="group relative bg-gray-50 p-2 rounded border border-gray-100 hover:border-indigo-200 transition-all">
                                                    <div className="flex justify-between items-start">
                                                        <div className="min-w-0">
                                                            <div className="font-mono font-bold text-gray-800 text-lg leading-none truncate">{p.mrn}</div>
                                                            <div className="flex gap-1 mt-1 flex-wrap">
                                                                <span className={`text-[10px] px-1.5 py-0.5 rounded font-bold ${p.level === 1 ? 'bg-red-100 text-red-700' : 'bg-gray-200 text-gray-600'}`}>L{p.level}</span>
                                                                {p.isMajorTrauma && <span className="text-[10px] px-1.5 py-0.5 rounded bg-orange-100 text-orange-800 font-bold">MT</span>}
                                                                {p.isOhca && <span className="text-[10px] px-1.5 py-0.5 rounded bg-black text-white font-bold">OHCA</span>}
                                                            </div>
                                                        </div>
                                                        <button 
                                                            onClick={() => handleDeletePatient(p.id)} 
                                                            disabled={!isAdmin}
                                                            className="text-gray-400 hover:text-red-600 p-1.5 rounded-full hover:bg-red-50 transition-colors disabled:hidden" 
                                                            title="ÁßªÈô§ÊéõËôü"
                                                        >
                                                            <Trash2 size={16} />
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

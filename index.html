<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>急診檢傷分診計數器 (正式版)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (UMD globals) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* Custom scrollbar for better look */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useMemo } = React;
        const { createRoot } = ReactDOM;

        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { 
            getFirestore, collection, doc, setDoc, onSnapshot, 
            updateDoc, deleteDoc, serverTimestamp, query, orderBy, runTransaction 
        } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
        import { 
            getAuth, signInAnonymously, onAuthStateChanged 
        } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';

        // --- Icons ---
        const Activity = ({ className, size }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
        );
        const PauseCircle = ({ className, size }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><line x1="10" y1="15" x2="10" y2="9"></line><line x1="14" y1="15" x2="14" y2="9"></line></svg>
        );
        const RotateCw = ({ className, size }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path></svg>
        );
        const Trash2 = ({ className, size }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
        );
        const Plus = ({ className, size }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        );
        const CheckCircle = ({ className, size }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
        );
        const Settings = ({ className, size }) => (
             <svg xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
        );

        // --- Firebase Config & Init (正式環境) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAA9_VgFhFKJZidgfbYkAI4g46SowgVBYY",
            authDomain: "er-triage-b1ac6.firebaseapp.com",
            projectId: "er-triage-b1ac6",
            storageBucket: "er-triage-b1ac6.firebasestorage.app",
            messagingSenderId: "691660481020",
            appId: "1:691660481020:web:8c06b22c69320cbce81279"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // 使用簡單的集合名稱，不需要 appId 路徑了
        const PATIENTS_COLLECTION = 'er_triage_patients';
        const STATE_COLLECTION = 'er_triage_state';
        const STATE_DOC_ID = 'main_v2';

        // --- Constants ---
        const ROOM_DEFINITIONS = [
            { id: 1, name: '診一', color: 'bg-yellow-200', header: 'bg-yellow-400', border: 'border-yellow-400', text: 'text-yellow-900' },
            { id: 2, name: '診二', color: 'bg-green-200', header: 'bg-green-500', border: 'border-green-500', text: 'text-green-900' },
            { id: 3, name: '診三', color: 'bg-blue-200', header: 'bg-blue-400', border: 'border-blue-400', text: 'text-blue-900' },
            { id: 4, name: '診四', color: 'bg-orange-200', header: 'bg-orange-400', border: 'border-orange-400', text: 'text-orange-900' },
            { id: 5, name: '診五', color: 'bg-pink-200', header: 'bg-pink-400', border: 'border-pink-400', text: 'text-pink-900' },
            { id: 6, name: '診六', color: 'bg-purple-200', header: 'bg-purple-400', border: 'border-purple-400', text: 'text-purple-900' },
            { id: 7, name: '診七', color: 'bg-teal-200', header: 'bg-teal-400', border: 'border-teal-400', text: 'text-teal-900' },
        ];

        const INITIAL_STATE = {
            activeRoomCount: 4, 
            rotation: {
                level1_next: 1,
                others_next: 1
            },
            suspensions: {}
        };

        const SUSPENSION_DURATION_MS = 30 * 60 * 1000;

        function App() {
            const [user, setUser] = useState(null);
            const [patients, setPatients] = useState([]);
            const [systemState, setSystemState] = useState(INITIAL_STATE);
            
            // Local UI State
            const [inputMrn, setInputMrn] = useState('');
            const [inputLevel, setInputLevel] = useState(3);
            const [isMajorTrauma, setIsMajorTrauma] = useState(false);
            const [isOhca, setIsOhca] = useState(false);
            const [loading, setLoading] = useState(false);
            const [, setTick] = useState(0);

            // --- Auth & Data Fetching ---
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        // 在正式環境，直接使用匿名登入即可
                        await signInAnonymously(auth);
                    } catch (e) {
                        console.error("Auth error", e);
                    }
                };
                initAuth();
                
                const unsubscribe = onAuthStateChanged(auth, setUser);
                const timer = setInterval(() => setTick(t => t + 1), 60000);
                return () => {
                    unsubscribe();
                    clearInterval(timer);
                };
            }, []);

            useEffect(() => {
                if (!user) return;

                // 1. Patients (從全域集合讀取)
                const qPatients = query(
                    collection(db, PATIENTS_COLLECTION),
                    orderBy('timestamp', 'desc')
                );
                const unsubPatients = onSnapshot(qPatients, (snapshot) => {
                    const list = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setPatients(list);
                }, (error) => console.error("Patients fetch error:", error));

                // 2. System State (從全域集合讀取)
                const docRef = doc(db, STATE_COLLECTION, STATE_DOC_ID);
                const unsubState = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        setSystemState(docSnap.data());
                    } else {
                        setDoc(docRef, INITIAL_STATE);
                    }
                }, (error) => console.error("State fetch error:", error));

                return () => {
                    unsubPatients();
                    unsubState();
                };
            }, [user]);

            // --- Logic Helpers ---
            const activeRoomCount = systemState.activeRoomCount || 4;
            const activeRooms = ROOM_DEFINITIONS.slice(0, activeRoomCount);

            const isRoomSuspended = (roomId) => {
                const suspendedUntil = systemState.suspensions?.[roomId];
                if (!suspendedUntil) return false;
                return suspendedUntil > Date.now();
            };

            const getRotationType = (level) => {
                return parseInt(level) === 1 ? 'level1_next' : 'others_next';
            };

            // Calculate Next Available Room
            const calculateNextRoom = (level) => {
                const rotationKey = getRotationType(level);
                let pointer = systemState.rotation?.[rotationKey] || 1;
                
                if (pointer > activeRoomCount) pointer = 1;

                let attempts = 0;
                while (isRoomSuspended(pointer) && attempts < activeRoomCount) {
                    pointer = (pointer % activeRoomCount) + 1;
                    attempts++;
                }
                return pointer;
            };

            const suggestedRoomId = useMemo(() => {
                return calculateNextRoom(inputLevel);
            }, [inputLevel, systemState, activeRoomCount]);

            // --- Stats Calculation ---
            const stats = useMemo(() => {
                const initialStats = {};
                ROOM_DEFINITIONS.forEach(r => {
                    initialStats[r.id] = { level1: 0, others: 0, mt: 0, ohca: 0 };
                });

                patients.forEach(p => {
                    if (initialStats[p.roomId]) {
                        if (p.level === 1) initialStats[p.roomId].level1++;
                        else initialStats[p.roomId].others++;
                        
                        if (p.isMajorTrauma) initialStats[p.roomId].mt++;
                        if (p.isOhca) initialStats[p.roomId].ohca++;
                    }
                });
                return initialStats;
            }, [patients]);

            // --- Actions ---
            const updateActiveRoomCount = async (count) => {
                const stateRef = doc(db, STATE_COLLECTION, STATE_DOC_ID);
                await updateDoc(stateRef, { activeRoomCount: count });
            };

            const handleAddPatient = async () => {
                if (!inputMrn.trim()) return;
                if (!user) return;
                setLoading(true);

                try {
                    const assignedRoomId = suggestedRoomId;
                    const rotationKey = getRotationType(inputLevel);
                    
                    const newPatient = {
                        mrn: inputMrn.trim(),
                        level: parseInt(inputLevel),
                        isMajorTrauma,
                        isOhca,
                        roomId: assignedRoomId,
                        timestamp: Date.now() 
                    };

                    await runTransaction(db, async (transaction) => {
                        const newPatientRef = doc(collection(db, PATIENTS_COLLECTION));
                        transaction.set(newPatientRef, newPatient);

                        const stateRef = doc(db, STATE_COLLECTION, STATE_DOC_ID);
                        const stateDoc = await transaction.get(stateRef);
                        
                        let currentState = stateDoc.exists() ? stateDoc.data() : INITIAL_STATE;
                        let currentRotation = currentState.rotation || INITIAL_STATE.rotation;
                        let currentCount = currentState.activeRoomCount || 4;

                        let nextPointer = (assignedRoomId % currentCount) + 1;
                        
                        const newRotation = {
                            ...currentRotation,
                            [rotationKey]: nextPointer
                        };

                        transaction.update(stateRef, { 
                            rotation: newRotation 
                        });
                    });

                    setInputMrn('');
                    setIsMajorTrauma(false);
                    setIsOhca(false);
                    
                } catch (e) {
                    console.error("Add patient failed", e);
                    // 這裡修改為顯示詳細錯誤，方便除錯
                    alert(`掛號失敗: ${e.message}\n(請檢查 Firebase Firestore 規則是否設為 allow read, write: if true;)`);
                } finally {
                    setLoading(false);
                }
            };

            const handleDeletePatient = async (id) => {
                if (window.confirm && !window.confirm('確定要移除此病歷號嗎？')) return; 
                try {
                    await deleteDoc(doc(db, PATIENTS_COLLECTION, id));
                } catch (e) { console.error(e); }
            };

            const toggleSuspension = async (roomId) => {
                const current = systemState.suspensions?.[roomId];
                const isSuspended = current && current > Date.now();
                const newState = isSuspended ? null : Date.now() + SUSPENSION_DURATION_MS;
                
                const stateRef = doc(db, STATE_COLLECTION, STATE_DOC_ID);
                await updateDoc(stateRef, {
                    [`suspensions.${roomId}`]: newState
                });
            };

            // --- Render Helpers ---
            const getFormatRemainingTime = (timestamp) => {
                if (!timestamp) return '';
                const diff = Math.ceil((timestamp - Date.now()) / 60000);
                return diff > 0 ? `${diff} 分鐘` : '即將恢復';
            };

            const gridStyle = {
                display: 'grid',
                gridTemplateColumns: `100px repeat(${activeRoomCount}, minmax(0, 1fr))`,
                gap: '0.5rem'
            };

            return (
                <div className="min-h-screen bg-gray-50 text-gray-800 font-sans p-2 md:p-4">
                    {/* HEADER */}
                    <header className="mb-6 bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                        <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                            <div className="flex items-center gap-3">
                                <Activity className="text-red-600 w-8 h-8" />
                                <h1 className="text-2xl font-bold tracking-tight text-gray-800">急診檢傷分流計數器 (正式版)</h1>
                            </div>
                            
                            <div className="flex items-center gap-2 bg-gray-100 p-1.5 rounded-lg border border-gray-200 overflow-x-auto max-w-full">
                                <div className="text-xs font-bold text-gray-500 px-2 whitespace-nowrap flex items-center gap-1">
                                    <Settings size={14}/> 開診數:
                                </div>
                                {[1, 2, 3, 4, 5, 6, 7].map(num => (
                                    <button
                                        key={num}
                                        onClick={() => updateActiveRoomCount(num)}
                                        className={`w-8 h-8 rounded-md font-bold text-sm transition-all
                                            ${activeRoomCount === num 
                                                ? 'bg-indigo-600 text-white shadow' 
                                                : 'bg-white text-gray-600 hover:bg-gray-200'}`}
                                    >
                                        {num}
                                    </button>
                                ))}
                            </div>

                            <div className="text-sm text-gray-500 flex items-center gap-2 whitespace-nowrap">
                                <span className={`w-2.5 h-2.5 rounded-full ${user ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`}></span>
                                {user ? '已連線同步中' : '連線中...'}
                            </div>
                        </div>
                    </header>

                    {/* DASHBOARD */}
                    <div className="mb-6 overflow-x-auto pb-2">
                        <div style={gridStyle} className="min-w-[600px]">
                            {/* Headers */}
                            <div className="flex flex-col gap-2 pt-14 text-right pr-4 font-bold text-gray-600 text-sm md:text-base">
                                <div className="h-10 flex items-center justify-end">狀態</div>
                                <div className="h-8 flex items-center justify-end">一級病人</div>
                                <div className="h-8 flex items-center justify-end">其他病人</div>
                                <div className="h-8 flex items-center justify-end text-red-600">Major Trauma</div>
                                <div className="h-8 flex items-center justify-end text-red-600">OHCA</div>
                                <div className="h-8 flex items-center justify-end text-blue-600">一級輪序</div>
                                <div className="h-8 flex items-center justify-end text-green-600">其他輪序</div>
                            </div>

                            {/* Rooms */}
                            {activeRooms.map(room => {
                                const isSuspended = isRoomSuspended(room.id);
                                const nextForLevel1 = calculateNextRoom(1) === room.id;
                                const nextForOthers = calculateNextRoom(3) === room.id;

                                return (
                                    <div key={room.id} className={`flex flex-col gap-2 rounded-lg ${room.color} bg-opacity-20 p-2 border ${room.border}`}>
                                        <div className={`${room.header} text-white font-bold text-center py-2 rounded shadow-sm text-lg relative whitespace-nowrap overflow-hidden text-ellipsis`}>
                                            {room.name}
                                            {isSuspended && (
                                                <div className="absolute top-0 right-0 left-0 bottom-0 bg-red-600 bg-opacity-90 text-white flex items-center justify-center text-xs font-bold animate-pulse">
                                                    停診中
                                                </div>
                                            )}
                                        </div>

                                        <div className="h-10 flex items-center justify-center">
                                            <button
                                                onClick={() => toggleSuspension(room.id)}
                                                className={`text-[10px] md:text-xs w-full py-1 rounded border shadow-sm transition-colors flex items-center justify-center gap-1 font-bold
                                                    ${isSuspended 
                                                    ? 'bg-red-100 border-red-300 text-red-700 hover:bg-red-200' 
                                                    : 'bg-white border-gray-300 text-gray-600 hover:bg-gray-100'
                                                    }`}
                                            >
                                                {isSuspended ? (
                                                    <span className="flex flex-col items-center leading-none">
                                                        <span>恢復</span>
                                                        <span className="scale-90 opacity-80">{getFormatRemainingTime(systemState.suspensions[room.id])}</span>
                                                    </span>
                                                ) : (
                                                    <>
                                                        <PauseCircle size={14} /> 停診 30m
                                                    </>
                                                )}
                                            </button>
                                        </div>

                                        <div className="h-8 flex items-center justify-center font-mono font-bold text-xl bg-white bg-opacity-50 rounded">{stats[room.id]?.level1 || 0}</div>
                                        <div className="h-8 flex items-center justify-center font-mono font-bold text-xl bg-white bg-opacity-50 rounded">{stats[room.id]?.others || 0}</div>
                                        <div className="h-8 flex items-center justify-center font-mono font-bold text-xl bg-white bg-opacity-50 rounded text-red-700">{stats[room.id]?.mt || 0}</div>
                                        <div className="h-8 flex items-center justify-center font-mono font-bold text-xl bg-white bg-opacity-50 rounded text-red-700">{stats[room.id]?.ohca || 0}</div>
                                        
                                        <div className="h-8 flex items-center justify-center">
                                            {nextForLevel1 ? <div className="w-full h-full bg-blue-500 text-white rounded flex items-center justify-center text-xs font-bold animate-pulse shadow">NEXT</div> : <span className="text-gray-300">-</span>}
                                        </div>
                                        <div className="h-8 flex items-center justify-center">
                                            {nextForOthers ? <div className="w-full h-full bg-green-500 text-white rounded flex items-center justify-center text-xs font-bold animate-pulse shadow">NEXT</div> : <span className="text-gray-300">-</span>}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {/* INPUT AREA */}
                    <div className="bg-white rounded-xl shadow-md p-4 md:p-6 border-l-4 border-indigo-500 mb-6">
                        <h2 className="text-lg font-bold mb-4 flex items-center gap-2 text-indigo-700">
                            <Plus className="w-5 h-5" />
                            新病人掛號輸入
                        </h2>
                        
                        <div className="flex flex-col lg:flex-row gap-6 items-start lg:items-end">
                            <div className="flex-1 w-full">
                                <label className="block text-sm font-bold text-gray-700 mb-1">病歷號 (MRN)</label>
                                <input 
                                    type="text" 
                                    value={inputMrn}
                                    onChange={(e) => setInputMrn(e.target.value)}
                                    placeholder="輸入病歷號..."
                                    className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none text-xl font-mono"
                                    onKeyDown={(e) => e.key === 'Enter' && handleAddPatient()}
                                />
                            </div>

                            <div className="w-full lg:w-48">
                                <label className="block text-sm font-bold text-gray-700 mb-1">檢傷級數</label>
                                <select 
                                    value={inputLevel} 
                                    onChange={(e) => setInputLevel(e.target.value)}
                                    className={`w-full p-3 border-2 rounded-lg focus:outline-none font-bold text-lg
                                        ${parseInt(inputLevel) === 1 ? 'border-red-500 bg-red-50 text-red-700' : 'border-gray-300'}`}
                                >
                                    <option value="1">1 級 (Level 1)</option>
                                    <option value="2">2 級 (Level 2)</option>
                                    <option value="3">3 級 (Level 3)</option>
                                    <option value="4">4 級 (Level 4)</option>
                                    <option value="5">5 級 (Level 5)</option>
                                </select>
                            </div>

                            <div className="flex flex-wrap gap-2 md:gap-4 mb-2 lg:mb-3 w-full lg:w-auto">
                                <label className={`flex-1 lg:flex-none flex items-center justify-center gap-2 px-3 py-2 rounded cursor-pointer transition-all border-2
                                    ${isMajorTrauma ? 'bg-red-100 border-red-500 text-red-700 font-bold' : 'bg-gray-100 border-gray-200 text-gray-500'}`}>
                                    <input 
                                        type="checkbox" 
                                        checked={isMajorTrauma} 
                                        onChange={(e) => setIsMajorTrauma(e.target.checked)}
                                        className="w-5 h-5 accent-red-600"
                                    />
                                    <span className="whitespace-nowrap">Major Trauma</span>
                                </label>

                                <label className={`flex-1 lg:flex-none flex items-center justify-center gap-2 px-3 py-2 rounded cursor-pointer transition-all border-2
                                    ${isOhca ? 'bg-black text-white border-black font-bold' : 'bg-gray-100 border-gray-200 text-gray-500'}`}>
                                    <input 
                                        type="checkbox" 
                                        checked={isOhca} 
                                        onChange={(e) => {
                                            setIsOhca(e.target.checked);
                                            if (e.target.checked) setInputLevel(1); 
                                        }}
                                        className="w-5 h-5 accent-red-600"
                                    />
                                    <span className="whitespace-nowrap">OHCA</span>
                                </label>
                            </div>

                            <div className="flex items-center gap-4 w-full lg:w-auto">
                                <div className="flex flex-col items-center px-4 bg-gray-50 rounded border border-gray-200 py-1">
                                    <span className="text-[10px] text-gray-500 uppercase font-bold tracking-wider">建議掛號</span>
                                    <span className={`text-2xl font-black ${activeRooms[suggestedRoomId-1]?.text || 'text-gray-800'}`}>
                                        {activeRooms[suggestedRoomId-1]?.name || '---'}
                                    </span>
                                </div>
                                
                                <button
                                    onClick={handleAddPatient}
                                    disabled={!inputMrn || loading}
                                    className="flex-1 bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-400 text-white px-6 py-3 rounded-lg font-bold shadow-lg transition-transform active:scale-95 text-lg flex items-center justify-center gap-2 whitespace-nowrap"
                                >
                                    {loading ? <RotateCw className="animate-spin" /> : <><CheckCircle /> 確認掛號</>}
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* PATIENT LIST */}
                    <h3 className="text-xl font-bold text-gray-700 mb-4 pl-2 border-l-4 border-gray-400">目前清單 (List)</h3>
                    <div className="overflow-x-auto pb-4">
                        <div style={gridStyle} className="min-w-[600px]">
                            <div className="pt-2 text-right pr-4 text-gray-500 font-medium text-sm">
                                <div>時間 / 項目</div>
                            </div>

                            {activeRooms.map(room => {
                                const roomPatients = patients.filter(p => p.roomId === room.id);
                                return (
                                    <div key={room.id} className="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden flex flex-col min-h-[300px]">
                                        <div className={`${room.header} text-white font-bold text-center py-1 text-sm`}>
                                            {room.name}
                                        </div>
                                        <div className="p-2 flex-1 overflow-y-auto max-h-[500px] space-y-2">
                                            {roomPatients.length === 0 && (
                                                <div className="text-center text-gray-300 py-8 text-sm italic">無病人</div>
                                            )}
                                            {roomPatients.map(p => (
                                                <div key={p.id} className="group relative bg-gray-50 p-2 rounded border border-gray-100 hover:border-indigo-200 transition-all">
                                                    <div className="flex justify-between items-start">
                                                        <div className="min-w-0">
                                                            <div className="font-mono font-bold text-gray-800 text-lg leading-none truncate">{p.mrn}</div>
                                                            <div className="flex gap-1 mt-1 flex-wrap">
                                                                <span className={`text-[10px] px-1.5 py-0.5 rounded font-bold ${p.level === 1 ? 'bg-red-100 text-red-700' : 'bg-gray-200 text-gray-600'}`}>
                                                                    L{p.level}
                                                                </span>
                                                                {p.isMajorTrauma && <span className="text-[10px] px-1.5 py-0.5 rounded bg-orange-100 text-orange-800 font-bold">MT</span>}
                                                                {p.isOhca && <span className="text-[10px] px-1.5 py-0.5 rounded bg-black text-white font-bold">OHCA</span>}
                                                            </div>
                                                        </div>
                                                        <button 
                                                            onClick={() => handleDeletePatient(p.id)}
                                                            className="text-gray-400 hover:text-red-600 p-1.5 rounded-full hover:bg-red-50 transition-colors"
                                                            title="移除掛號"
                                                        >
                                                            <Trash2 size={16} />
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

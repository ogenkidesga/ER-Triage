<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>急診檢傷分診計數器 (v3.3 智慧警示版)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (UMD globals) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* Custom scrollbar for better look */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        /* Animation for countdown */
        @keyframes pulse-red {
            0%, 100% { color: #dc2626; }
            50% { color: #991b1b; }
        }
        .countdown-text {
            animation: pulse-red 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Animation for Time Up Alert */
        @keyframes flash-warning {
            0%, 100% { background-color: #fee2e2; border-color: #ef4444; } /* Red-100 */
            50% { background-color: #fca5a5; border-color: #b91c1c; } /* Red-300 */
        }
        .animate-flash-warning {
            animation: flash-warning 1s infinite;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useMemo, useRef } = React;
        const { createRoot } = ReactDOM;

        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { 
            getFirestore, collection, doc, setDoc, onSnapshot, 
            updateDoc, deleteDoc, serverTimestamp, query, orderBy, runTransaction, writeBatch, where, getDocs
        } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
        import { 
            getAuth, signInAnonymously, onAuthStateChanged 
        } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';

        // --- Icons ---
        const Activity = ({ className, size }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
        );
        const PauseCircle = ({ className, size }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><line x1="10" y1="15" x2="10" y2="9"></line><line x1="14" y1="15" x2="14" y2="9"></line></svg>
        );
        const RotateCw = ({ className, size }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path></svg>
        );
        const Trash2 = ({ className, size }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
        );
        const Plus = ({ className, size }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        );
        const CheckCircle = ({ className, size }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
        );
        const Settings = ({ className, size }) => (
             <svg xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
        );
        const Stethoscope = ({ className, size }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M4.8 2.3A.3.3 0 1 0 5.2.7l-1.5 2.5 1.1-.9z"></path><path d="M6 5a6 6 0 0 1 12 0v3"></path><path d="M11 17h2"></path><path d="M8 17a4 4 0 0 1 8 0v-4a2 2 0 1 0-4 0v2"></path><circle cx="12" cy="19" r="2"></circle></svg>
        );
        const XCircle = ({ className, size }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>
        );
        const RefreshCw = ({ className, size }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
        );
        const AlertTriangle = ({ className, size }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
        );

        // --- Firebase Config & Init (正式環境) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAA9_VgFhFKJZidgfbYkAI4g46SowgVBYY",
            authDomain: "er-triage-b1ac6.firebaseapp.com",
            projectId: "er-triage-b1ac6",
            storageBucket: "er-triage-b1ac6.firebasestorage.app",
            messagingSenderId: "691660481020",
            appId: "1:691660481020:web:8c06b22c69320cbce81279"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const PATIENTS_COLLECTION = 'er_triage_patients';
        const STATE_COLLECTION = 'er_triage_state';
        const STATE_DOC_ID = 'main_v2';

        // --- Constants ---
        const ROOM_DEFINITIONS = [
            { id: 1, name: '診一', color: 'bg-yellow-200', header: 'bg-yellow-400', border: 'border-yellow-400', text: 'text-yellow-900' },
            { id: 2, name: '診二', color: 'bg-green-200', header: 'bg-green-500', border: 'border-green-500', text: 'text-green-900' },
            { id: 3, name: '診三', color: 'bg-blue-200', header: 'bg-blue-400', border: 'border-blue-400', text: 'text-blue-900' },
            { id: 4, name: '診四', color: 'bg-orange-200', header: 'bg-orange-400', border: 'border-orange-400', text: 'text-orange-900' },
            { id: 5, name: '診五', color: 'bg-pink-200', header: 'bg-pink-400', border: 'border-pink-400', text: 'text-pink-900' },
            { id: 6, name: '診六', color: 'bg-purple-200', header: 'bg-purple-400', border: 'border-purple-400', text: 'text-purple-900' },
            { id: 7, name: '診七', color: 'bg-teal-200', header: 'bg-teal-400', border: 'border-teal-400', text: 'text-teal-900' },
        ];

        const INITIAL_STATE = {
            activeRoomCount: 4, 
            rotation: {
                level1_next: 1,
                others_next: 1
            },
            suspensions: {}
        };

        const SUSPENSION_DURATION_MS = 30 * 60 * 1000;

        // --- Modal Components ---
        const Modal = ({ isOpen, onClose, title, children, showClose = true }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-60 backdrop-blur-sm animate-[fadeIn_0.2s_ease-out]">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all scale-100">
                        <div className="flex justify-between items-center p-4 border-b bg-gray-50">
                            <h3 className="text-xl font-bold text-gray-800 flex items-center gap-2">{title}</h3>
                            {showClose && (
                                <button onClick={onClose} className="text-gray-500 hover:text-gray-700 p-1 rounded-full hover:bg-gray-200">
                                    <XCircle size={24} />
                                </button>
                            )}
                        </div>
                        <div className="p-6">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        function App() {
            const [user, setUser] = useState(null);
            const [patients, setPatients] = useState([]);
            const [systemState, setSystemState] = useState(INITIAL_STATE);
            
            // Local UI State
            const [inputMrn, setInputMrn] = useState('');
            const [inputLevel, setInputLevel] = useState(3);
            const [isMajorTrauma, setIsMajorTrauma] = useState(false);
            const [isOhca, setIsOhca] = useState(false);
            const [loading, setLoading] = useState(false);
            const [, setTick] = useState(0);
            
            const [targetRoom, setTargetRoom] = useState(1);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [adminLoading, setAdminLoading] = useState(false);

            // New State for Critical Patient Confirmation
            const [criticalConfirmData, setCriticalConfirmData] = useState(null);

            // --- Auth & Data Fetching ---
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        await signInAnonymously(auth);
                    } catch (e) {
                        console.error("Auth error", e);
                    }
                };
                initAuth();
                
                const unsubscribe = onAuthStateChanged(auth, setUser);
                const timer = setInterval(() => setTick(t => t + 1), 1000);
                return () => {
                    unsubscribe();
                    clearInterval(timer);
                };
            }, []);

            useEffect(() => {
                if (!user) return;

                // 1. Patients
                const qPatients = query(collection(db, PATIENTS_COLLECTION), orderBy('timestamp', 'desc'));
                const unsubPatients = onSnapshot(qPatients, (snapshot) => {
                    const list = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setPatients(list);
                }, (error) => console.error("Patients fetch error:", error));

                // 2. System State
                const docRef = doc(db, STATE_COLLECTION, STATE_DOC_ID);
                const unsubState = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        setSystemState(docSnap.data());
                    } else {
                        setDoc(docRef, INITIAL_STATE);
                    }
                }, (error) => console.error("State fetch error:", error));

                return () => {
                    unsubPatients();
                    unsubState();
                };
            }, [user]);

            // --- Logic Helpers ---
            const activeRoomCount = systemState.activeRoomCount || 4;
            const activeRooms = ROOM_DEFINITIONS.slice(0, activeRoomCount);

            // Updated Logic: Check for *active* suspension vs *expired* suspension
            const getRoomSuspensionState = (roomId) => {
                const suspendedUntil = systemState.suspensions?.[roomId];
                if (!suspendedUntil) return 'NONE'; // No suspension record
                if (suspendedUntil > Date.now()) return 'ACTIVE'; // Counting down
                return 'EXPIRED'; // Time reached 0, but record still exists (Alert state)
            };

            const isRoomActiveSuspension = (roomId) => {
                return getRoomSuspensionState(roomId) === 'ACTIVE';
            };
            
            // Logic for pointer skipping: We only skip if ACTIVELY suspended
            const isRoomSkippable = (roomId) => {
                return isRoomActiveSuspension(roomId);
            };

            const getRotationType = (level) => {
                return parseInt(level) === 1 ? 'level1_next' : 'others_next';
            };

            const calculateNextRoom = (level) => {
                const rotationKey = getRotationType(level);
                let pointer = systemState.rotation?.[rotationKey] || 1;
                if (pointer > activeRoomCount) pointer = 1;
                let attempts = 0;
                while (isRoomSkippable(pointer) && attempts < activeRoomCount) {
                    pointer = (pointer % activeRoomCount) + 1;
                    attempts++;
                }
                return pointer;
            };

            const suggestedRoomId = useMemo(() => {
                return calculateNextRoom(inputLevel);
            }, [inputLevel, systemState, activeRoomCount]);

            useEffect(() => {
                setTargetRoom(suggestedRoomId);
            }, [suggestedRoomId]);

            const stats = useMemo(() => {
                const initialStats = {};
                ROOM_DEFINITIONS.forEach(r => {
                    initialStats[r.id] = { level1: 0, others: 0, mt: 0, ohca: 0 };
                });
                patients.forEach(p => {
                    if (initialStats[p.roomId]) {
                        if (p.level === 1) initialStats[p.roomId].level1++;
                        else initialStats[p.roomId].others++;
                        if (p.isMajorTrauma) initialStats[p.roomId].mt++;
                        if (p.isOhca) initialStats[p.roomId].ohca++;
                    }
                });
                return initialStats;
            }, [patients]);

            // --- Actions ---

            // 1. Initial Trigger for Add Patient
            const handleAddPatientClick = () => {
                if (!inputMrn.trim()) return;
                
                // 判斷是否為重症
                if (isOhca || isMajorTrauma) {
                    setCriticalConfirmData({
                        targetRoomName: activeRooms.find(r => r.id === parseInt(targetRoom))?.name || `診${targetRoom}`
                    });
                    return; // Stop here, wait for modal
                }
                
                // 一般病人直接掛號
                performAddPatient(false);
            };

            // 2. Actual DB Operation
            const performAddPatient = async (shouldSuspendRoom) => {
                if (!user) return;
                setLoading(true);
                setCriticalConfirmData(null); // Close modal if open

                try {
                    const assignedRoomId = parseInt(targetRoom);
                    const rotationKey = getRotationType(inputLevel);
                    
                    const newPatient = {
                        mrn: inputMrn.trim(),
                        level: parseInt(inputLevel),
                        isMajorTrauma,
                        isOhca,
                        roomId: assignedRoomId,
                        timestamp: Date.now() 
                    };

                    await runTransaction(db, async (transaction) => {
                        const stateRef = doc(db, STATE_COLLECTION, STATE_DOC_ID);
                        const stateDoc = await transaction.get(stateRef);
                        
                        let currentState = stateDoc.exists() ? stateDoc.data() : INITIAL_STATE;
                        let currentRotation = currentState.rotation || INITIAL_STATE.rotation;
                        let currentCount = currentState.activeRoomCount || 4;

                        let nextPointer = (assignedRoomId % currentCount) + 1;
                        
                        const newRotation = {
                            ...currentRotation,
                            [rotationKey]: nextPointer
                        };

                        const newPatientRef = doc(collection(db, PATIENTS_COLLECTION));
                        transaction.set(newPatientRef, newPatient);
                        
                        let updatePayload = { rotation: newRotation };
                        
                        // Handle Automatic Suspension if requested
                        if (shouldSuspendRoom) {
                            const newSuspensionTime = Date.now() + SUSPENSION_DURATION_MS;
                            updatePayload[`suspensions.${assignedRoomId}`] = newSuspensionTime;
                        }

                        transaction.set(stateRef, updatePayload, { merge: true });
                    });

                    setInputMrn('');
                    setIsMajorTrauma(false);
                    setIsOhca(false);
                    
                } catch (e) {
                    console.error("Add patient failed", e);
                    alert(`掛號失敗: ${e.message}`);
                } finally {
                    setLoading(false);
                }
            };

            const toggleSuspension = async (roomId) => {
                const state = getRoomSuspensionState(roomId);
                // If Active or Expired, we want to Clear it (Resume). 
                // If None, we want to Start it (Suspend).
                const shouldSuspend = state === 'NONE';
                
                const newState = shouldSuspend ? Date.now() + SUSPENSION_DURATION_MS : null;
                
                const stateRef = doc(db, STATE_COLLECTION, STATE_DOC_ID);
                
                // If we are clearing a specific room, use deleteField() pattern ideally, 
                // but setting to null or removing key works with how we parse it.
                // Firestore update with nested fields:
                await updateDoc(stateRef, {
                    [`suspensions.${roomId}`]: newState || 0 // Use 0 or null to signify removal logic
                });
                
                if (!shouldSuspend) {
                    // Cleanup: actually delete the field to keep DB clean (optional but good)
                    // For simplicity, we just set it to null/0 above and check for truthiness
                }
            };

            const handleResetRotation = async (mode) => {
                if (!window.confirm("確定重置輪序?")) return;
                setAdminLoading(true);
                try {
                    const updateData = mode === 'all' 
                        ? { 'rotation.level1_next': 1, 'rotation.others_next': 1 }
                        : mode === 'level1' ? { 'rotation.level1_next': 1 } : { 'rotation.others_next': 1 };
                    
                    await updateDoc(doc(db, STATE_COLLECTION, STATE_DOC_ID), updateData);
                } catch (e) { alert(e.message); }
                finally { setAdminLoading(false); }
            };

            const handleClearPatients = async (roomId) => {
                if (!window.confirm("確定清空病人資料?")) return;
                setAdminLoading(true);
                try {
                    const q = roomId ? query(collection(db, PATIENTS_COLLECTION), where("roomId", "==", roomId)) : query(collection(db, PATIENTS_COLLECTION));
                    const snapshot = await getDocs(q);
                    const batch = writeBatch(db);
                    snapshot.docs.forEach(d => batch.delete(d.ref));
                    await batch.commit();
                } catch (e) { alert(e.message); }
                finally { setAdminLoading(false); }
            };

            const handleDeletePatient = async (id) => {
                if (window.confirm && !window.confirm('確定要移除此病歷號嗎？')) return; 
                try { await deleteDoc(doc(db, PATIENTS_COLLECTION, id)); } catch (e) {}
            };

            // --- Render Helpers ---
            const getFormatRemainingTime = (timestamp) => {
                if (!timestamp) return '';
                const diff = timestamp - Date.now();
                if (diff <= 0) return '00分00秒'; // Should be handled by Expired state usually
                const m = Math.floor(diff / 60000);
                const s = Math.floor((diff % 60000) / 1000);
                const ss = s < 10 ? `0${s}` : s;
                return `${m}分${ss}秒`;
            };

            const gridStyle = {
                display: 'grid',
                gridTemplateColumns: `100px repeat(${activeRoomCount}, minmax(0, 1fr))`,
                gap: '0.5rem'
            };

            return (
                <div className="min-h-screen bg-gray-50 text-gray-800 font-sans p-2 md:p-4">
                    
                    {/* CRITICAL PATIENT MODAL */}
                    <Modal 
                        isOpen={!!criticalConfirmData} 
                        onClose={() => setCriticalConfirmData(null)}
                        title={<><AlertTriangle className="text-red-600" /> 重症病人確認</>}
                        showClose={false}
                    >
                         <div className="text-center space-y-4">
                            <p className="text-lg font-bold text-gray-800">
                                您正在將 <span className="text-red-600">OHCA/Trauma</span> 病人<br/>掛入 
                                <span className="text-indigo-600 text-2xl mx-2">{criticalConfirmData?.targetRoomName}</span>
                            </p>
                            <p className="text-gray-600">是否要同步將該診間設為<br/><span className="font-bold text-gray-800">停診 30 分鐘</span> 以進行急救？</p>
                            
                            <div className="flex flex-col gap-3 mt-4">
                                <button 
                                    onClick={() => performAddPatient(true)}
                                    className="w-full bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg font-bold shadow text-lg flex items-center justify-center gap-2"
                                >
                                    <PauseCircle size={20} /> 是，掛號並停診
                                </button>
                                <button 
                                    onClick={() => performAddPatient(false)}
                                    className="w-full bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-lg font-bold shadow text-lg"
                                >
                                    否，僅掛號
                                </button>
                                <button 
                                    onClick={() => setCriticalConfirmData(null)}
                                    className="w-full bg-white border-2 border-gray-300 text-gray-600 py-2 rounded-lg font-bold hover:bg-gray-50"
                                >
                                    取消
                                </button>
                            </div>
                        </div>
                    </Modal>

                    {/* ADMIN MODAL */}
                    <Modal 
                        isOpen={isSettingsOpen} 
                        onClose={() => setIsSettingsOpen(false)}
                        title="⚙️ 交班與系統管理"
                    >
                        <div className="space-y-6">
                            <div>
                                <h4 className="font-bold text-gray-700 mb-2 flex items-center gap-2">
                                    <RefreshCw size={18} /> 輪序重置
                                </h4>
                                <div className="grid grid-cols-2 gap-2 mb-2">
                                    <button disabled={adminLoading} onClick={() => handleResetRotation('level1')} className="bg-blue-100 text-blue-800 py-2 rounded font-bold">L1 重置</button>
                                    <button disabled={adminLoading} onClick={() => handleResetRotation('others')} className="bg-green-100 text-green-800 py-2 rounded font-bold">其他重置</button>
                                </div>
                                <button disabled={adminLoading} onClick={() => handleResetRotation('all')} className="w-full bg-indigo-100 text-indigo-800 py-2 rounded font-bold border-2 border-indigo-200">全部重置</button>
                            </div>
                            <hr className="border-gray-200" />
                            <div>
                                <h4 className="font-bold text-red-700 mb-2 flex items-center gap-2"><Trash2 size={18} /> 危險操作區</h4>
                                <button disabled={adminLoading} onClick={() => handleClearPatients(null)} className="w-full bg-red-600 text-white py-3 rounded-lg font-bold shadow">清除所有資料</button>
                            </div>
                        </div>
                    </Modal>

                    {/* HEADER */}
                    <header className="mb-6 bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                        <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                            <div className="flex items-center gap-3">
                                <Activity className="text-red-600 w-8 h-8" />
                                <h1 className="text-2xl font-bold tracking-tight text-gray-800">急診檢傷分流計數器 (v3.3 智慧警示)</h1>
                            </div>
                            <div className="flex items-center gap-2 bg-gray-100 p-1.5 rounded-lg border border-gray-200 overflow-x-auto max-w-full">
                                <div className="text-xs font-bold text-gray-500 px-2 whitespace-nowrap flex items-center gap-1"><Settings size={14}/> 開診:</div>
                                {[1, 2, 3, 4, 5, 6, 7].map(num => (
                                    <button key={num} onClick={() => updateActiveRoomCount(num)} className={`w-8 h-8 rounded-md font-bold text-sm ${activeRoomCount === num ? 'bg-indigo-600 text-white' : 'bg-white text-gray-600'}`}>{num}</button>
                                ))}
                            </div>
                            <div className="flex items-center gap-3">
                                <button onClick={() => setIsSettingsOpen(true)} className="flex items-center gap-1 bg-gray-100 text-gray-700 px-3 py-2 rounded-lg font-bold border border-gray-300 text-sm"><Settings size={16} /> 交班/管理</button>
                                <div className="text-sm text-gray-500 flex items-center gap-2 whitespace-nowrap"><span className={`w-2.5 h-2.5 rounded-full ${user ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`}></span>{user ? '連線中' : '...'}</div>
                            </div>
                        </div>
                    </header>

                    {/* DASHBOARD */}
                    <div className="mb-6 overflow-x-auto pb-2">
                        <div style={gridStyle} className="min-w-[600px]">
                            {/* Headers */}
                            <div className="flex flex-col gap-2 pt-14 text-right pr-4 font-bold text-gray-600 text-sm md:text-base">
                                <div className="h-10 flex items-center justify-end">狀態</div>
                                <div className="h-8 flex items-center justify-end">一級病人</div>
                                <div className="h-8 flex items-center justify-end">其他病人</div>
                                <div className="h-8 flex items-center justify-end text-red-600">Major Trauma</div>
                                <div className="h-8 flex items-center justify-end text-red-600">OHCA</div>
                                <div className="h-8 flex items-center justify-end text-blue-600">一級輪序</div>
                                <div className="h-8 flex items-center justify-end text-green-600">其他輪序</div>
                            </div>

                            {/* Rooms */}
                            {activeRooms.map(room => {
                                const suspensionState = getRoomSuspensionState(room.id); // NONE, ACTIVE, EXPIRED
                                const isSuspended = suspensionState !== 'NONE';
                                const nextForLevel1 = calculateNextRoom(1) === room.id;
                                const nextForOthers = calculateNextRoom(3) === room.id;

                                return (
                                    <div key={room.id} className={`flex flex-col gap-2 rounded-lg ${room.color} bg-opacity-20 p-2 border ${room.border}`}>
                                        <div className={`${room.header} text-white font-bold text-center py-2 rounded shadow-sm text-lg relative whitespace-nowrap overflow-hidden text-ellipsis`}>
                                            {room.name}
                                            {suspensionState === 'ACTIVE' && (
                                                <div className="absolute top-0 right-0 left-0 bottom-0 bg-red-600 bg-opacity-90 text-white flex items-center justify-center text-xs font-bold animate-pulse">
                                                    停診中
                                                </div>
                                            )}
                                            {suspensionState === 'EXPIRED' && (
                                                <div className="absolute top-0 right-0 left-0 bottom-0 bg-red-800 text-white flex items-center justify-center text-xs font-bold animate-bounce">
                                                    ⚠️ 時間到
                                                </div>
                                            )}
                                        </div>

                                        <div className="h-10 flex items-center justify-center">
                                            <button
                                                onClick={() => toggleSuspension(room.id)}
                                                className={`text-[10px] md:text-xs w-full py-1 rounded border shadow-sm transition-all flex items-center justify-center gap-1 font-bold h-full
                                                    ${suspensionState === 'ACTIVE' 
                                                        ? 'bg-red-50 border-red-300 text-red-700' 
                                                        : suspensionState === 'EXPIRED'
                                                            ? 'bg-red-100 border-red-500 text-red-800 animate-flash-warning'
                                                            : 'bg-white border-gray-300 text-gray-600 hover:bg-gray-100'
                                                    }`}
                                            >
                                                {suspensionState === 'ACTIVE' ? (
                                                    <span className="flex flex-col items-center leading-none">
                                                        <span>恢復</span>
                                                        <span className="scale-90 font-mono text-red-600 countdown-text text-xs mt-0.5">
                                                            {getFormatRemainingTime(systemState.suspensions[room.id])}
                                                        </span>
                                                    </span>
                                                ) : suspensionState === 'EXPIRED' ? (
                                                    <span className="flex flex-col items-center leading-none">
                                                        <span className="text-sm">時間到</span>
                                                        <span className="text-[10px]">點擊恢復</span>
                                                    </span>
                                                ) : (
                                                    <>
                                                        <PauseCircle size={14} /> 停診 30m
                                                    </>
                                                )}
                                            </button>
                                        </div>

                                        <div className="h-8 flex items-center justify-center font-mono font-bold text-xl bg-white bg-opacity-50 rounded">{stats[room.id]?.level1 || 0}</div>
                                        <div className="h-8 flex items-center justify-center font-mono font-bold text-xl bg-white bg-opacity-50 rounded">{stats[room.id]?.others || 0}</div>
                                        <div className="h-8 flex items-center justify-center font-mono font-bold text-xl bg-white bg-opacity-50 rounded text-red-700">{stats[room.id]?.mt || 0}</div>
                                        <div className="h-8 flex items-center justify-center font-mono font-bold text-xl bg-white bg-opacity-50 rounded text-red-700">{stats[room.id]?.ohca || 0}</div>
                                        
                                        <div className="h-8 flex items-center justify-center">
                                            {nextForLevel1 ? <div className="w-full h-full bg-blue-500 text-white rounded flex items-center justify-center text-xs font-bold animate-pulse shadow">NEXT</div> : <span className="text-gray-300">-</span>}
                                        </div>
                                        <div className="h-8 flex items-center justify-center">
                                            {nextForOthers ? <div className="w-full h-full bg-green-500 text-white rounded flex items-center justify-center text-xs font-bold animate-pulse shadow">NEXT</div> : <span className="text-gray-300">-</span>}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {/* INPUT AREA */}
                    <div className="bg-white rounded-xl shadow-md p-4 md:p-6 border-l-4 border-indigo-500 mb-6">
                        <h2 className="text-lg font-bold mb-4 flex items-center gap-2 text-indigo-700">
                            <Plus className="w-5 h-5" />
                            新病人掛號輸入
                        </h2>
                        
                        <div className="flex flex-col lg:flex-row gap-6 items-start lg:items-end">
                            <div className="flex-1 w-full">
                                <label className="block text-sm font-bold text-gray-700 mb-1">病歷號 (MRN)</label>
                                <input 
                                    type="text" 
                                    value={inputMrn}
                                    onChange={(e) => setInputMrn(e.target.value)}
                                    placeholder="輸入病歷號..."
                                    className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none text-xl font-mono"
                                    onKeyDown={(e) => e.key === 'Enter' && handleAddPatientClick()}
                                />
                            </div>

                            <div className="w-full lg:w-32">
                                <label className="block text-sm font-bold text-gray-700 mb-1">檢傷級數</label>
                                <select 
                                    value={inputLevel} 
                                    onChange={(e) => setInputLevel(e.target.value)}
                                    className={`w-full p-3 border-2 rounded-lg focus:outline-none font-bold text-lg
                                        ${parseInt(inputLevel) === 1 ? 'border-red-500 bg-red-50 text-red-700' : 'border-gray-300'}`}
                                >
                                    <option value="1">L1</option>
                                    <option value="2">L2</option>
                                    <option value="3">L3</option>
                                    <option value="4">L4</option>
                                    <option value="5">L5</option>
                                </select>
                            </div>

                            <div className="flex flex-wrap gap-2 md:gap-4 mb-2 lg:mb-3 w-full lg:w-auto">
                                <label className={`flex-1 lg:flex-none flex items-center justify-center gap-2 px-3 py-2 rounded cursor-pointer transition-all border-2
                                    ${isMajorTrauma ? 'bg-red-100 border-red-500 text-red-700 font-bold' : 'bg-gray-100 border-gray-200 text-gray-500'}`}>
                                    <input 
                                        type="checkbox" 
                                        checked={isMajorTrauma} 
                                        onChange={(e) => setIsMajorTrauma(e.target.checked)}
                                        className="w-5 h-5 accent-red-600"
                                    />
                                    <span className="whitespace-nowrap text-sm">Trauma</span>
                                </label>

                                <label className={`flex-1 lg:flex-none flex items-center justify-center gap-2 px-3 py-2 rounded cursor-pointer transition-all border-2
                                    ${isOhca ? 'bg-black text-white border-black font-bold' : 'bg-gray-100 border-gray-200 text-gray-500'}`}>
                                    <input 
                                        type="checkbox" 
                                        checked={isOhca} 
                                        onChange={(e) => {
                                            setIsOhca(e.target.checked);
                                            if (e.target.checked) setInputLevel(1); 
                                        }}
                                        className="w-5 h-5 accent-red-600"
                                    />
                                    <span className="whitespace-nowrap text-sm">OHCA</span>
                                </label>
                            </div>

                            <div className="flex items-center gap-4 w-full lg:w-auto">
                                <div className="flex flex-col w-full lg:w-48">
                                    <label className="block text-sm font-bold text-gray-700 mb-1 flex items-center gap-1">
                                        <Stethoscope size={14} /> 指定診間
                                    </label>
                                    <div className="relative">
                                        <select 
                                            value={targetRoom}
                                            onChange={(e) => setTargetRoom(e.target.value)}
                                            className={`w-full p-3 border-2 rounded-lg focus:outline-none font-bold text-lg appearance-none cursor-pointer
                                                ${parseInt(targetRoom) === suggestedRoomId 
                                                    ? 'border-indigo-300 bg-indigo-50 text-indigo-900' 
                                                    : 'border-gray-300 bg-white text-gray-900'}`}
                                        >
                                            {activeRooms.map(room => (
                                                <option key={room.id} value={room.id}>
                                                    {room.name} {suggestedRoomId === room.id ? '(建議)' : ''}
                                                </option>
                                            ))}
                                        </select>
                                        <div className="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                                            <svg className="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg>
                                        </div>
                                    </div>
                                </div>
                                
                                <button
                                    onClick={handleAddPatientClick}
                                    disabled={!inputMrn || loading}
                                    className="h-[52px] bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-400 text-white px-6 rounded-lg font-bold shadow-lg transition-transform active:scale-95 text-lg flex items-center justify-center gap-2 whitespace-nowrap self-end"
                                >
                                    {loading ? <RotateCw className="animate-spin" /> : <><CheckCircle /> 確認</>}
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* PATIENT LIST */}
                    <h3 className="text-xl font-bold text-gray-700 mb-4 pl-2 border-l-4 border-gray-400">目前清單 (List)</h3>
                    <div className="overflow-x-auto pb-4">
                        <div style={gridStyle} className="min-w-[600px]">
                            <div className="pt-2 text-right pr-4 text-gray-500 font-medium text-sm">
                                <div>時間 / 項目</div>
                            </div>
                            {activeRooms.map(room => {
                                const roomPatients = patients.filter(p => p.roomId === room.id);
                                return (
                                    <div key={room.id} className="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden flex flex-col min-h-[300px]">
                                        <div className={`${room.header} text-white font-bold text-center py-1 text-sm flex justify-between px-2 items-center`}>
                                            <span className="flex-1">{room.name}</span>
                                            <button onClick={() => handleClearPatients(room.id)} className="bg-white bg-opacity-20 hover:bg-opacity-40 rounded p-1 text-white transition-colors" title={`清空${room.name}病人`}><Trash2 size={12} /></button>
                                        </div>
                                        <div className="p-2 flex-1 overflow-y-auto max-h-[500px] space-y-2">
                                            {roomPatients.length === 0 && <div className="text-center text-gray-300 py-8 text-sm italic">無病人</div>}
                                            {roomPatients.map(p => (
                                                <div key={p.id} className="group relative bg-gray-50 p-2 rounded border border-gray-100 hover:border-indigo-200 transition-all">
                                                    <div className="flex justify-between items-start">
                                                        <div className="min-w-0">
                                                            <div className="font-mono font-bold text-gray-800 text-lg leading-none truncate">{p.mrn}</div>
                                                            <div className="flex gap-1 mt-1 flex-wrap">
                                                                <span className={`text-[10px] px-1.5 py-0.5 rounded font-bold ${p.level === 1 ? 'bg-red-100 text-red-700' : 'bg-gray-200 text-gray-600'}`}>L{p.level}</span>
                                                                {p.isMajorTrauma && <span className="text-[10px] px-1.5 py-0.5 rounded bg-orange-100 text-orange-800 font-bold">MT</span>}
                                                                {p.isOhca && <span className="text-[10px] px-1.5 py-0.5 rounded bg-black text-white font-bold">OHCA</span>}
                                                            </div>
                                                        </div>
                                                        <button onClick={() => handleDeletePatient(p.id)} className="text-gray-400 hover:text-red-600 p-1.5 rounded-full hover:bg-red-50 transition-colors" title="移除掛號"><Trash2 size={16} /></button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
